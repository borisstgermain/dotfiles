#!/bin/bash

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
DOTFILES_DIR="$HOME/dotfiles"       # –ü—É—Ç—å –∫ dotfiles
BACKUP_BASE_DIR="$DOTFILES_DIR/backups" # –ë–∞–∑–æ–≤–∞—è –ø–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
DATE=$(date +"%Y-%m-%d_%H-%M-%S")   # –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è –ø–∞–ø–∫–∏ –±—ç–∫–∞–ø–∞
BACKUP_DIR="$BACKUP_BASE_DIR/$DATE" # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞

# --- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ dotfiles ---
if [ ! -d "$DOTFILES_DIR" ]; then
    echo "‚ùå –ü–∞–ø–∫–∞ dotfiles –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $DOTFILES_DIR"
    exit 1
fi

# --- –ò—â–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ñ–∞–π–ª—ã ---
echo "‚è≥ –ü–æ–∏—Å–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤..."
CONFLICTS=()
shopt -s dotglob # –í–∫–ª—é—á–∞–µ–º –ø–æ–∏—Å–∫ —Å–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤ (*)
shopt -s nullglob # –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, find –Ω–µ –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É

for package_dir in "$DOTFILES_DIR"/*/; do
    package=$(basename "$package_dir")

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ-–ø–∞–∫–µ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∞–º backups)
    if [ "$package" == "backups" ] || [ ! -d "$package_dir" ]; then
        continue
    fi

    # echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–∫–µ—Ç: $package" # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

    # –ò—â–µ–º —Ñ–∞–π–ª—ã –≤ –ø–∞–∫–µ—Ç–µ (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ -mindepth 1)
    while IFS= read -r -d $'\0' file; do
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å —Ñ–∞–π–ª–∞ –≤–Ω—É—Ç—Ä–∏ –ø–∞–∫–µ—Ç–∞
        relative_path=${file#"$package_dir"}
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ü–µ–ª–µ–≤–æ–π –ø—É—Ç—å –≤ $HOME
        target_file="$HOME/$relative_path"

        # echo "  –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª: $file -> $target_file" # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω —Å–∏–º–ª–∏–Ω–∫–æ–º
        if [ -e "$target_file" ] && [ ! -L "$target_file" ]; then
            # echo "    –ö–û–ù–§–õ–ò–ö–¢: $target_file —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ —Å–∏–º–ª–∏–Ω–∫." # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            CONFLICTS+=("$target_file")
        fi
    done < <(find "$package_dir" -mindepth 1 -type f -print0) # –ò—Å–ø–æ–ª—å–∑—É–µ–º find –∏ null-—Ç–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä—ã –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

done

shopt -u dotglob nullglob # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ glob –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

# --- –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, –≤—ã—Ö–æ–¥–∏–º ---
if [ ${#CONFLICTS[@]} -eq 0 ]; then
    echo "‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤. –ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å stow."
    exit 0
fi

# --- –°–æ–æ–±—â–∞–µ–º –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö –∏ —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –±—ç–∫–∞–ø–∞ ---
echo "üîç –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ñ–∞–π–ª—ã:"
# –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –º–æ–≥ –±—ã—Ç—å –Ω–∞–π–¥–µ–Ω –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ)
UNIQUE_CONFLICTS=($(printf "%s\n" "${CONFLICTS[@]}" | sort -u))

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–∞ –¢–û–õ–¨–ö–û –°–ï–ô–ß–ê–°
echo "–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –±—ç–∫–∞–ø–∞: $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"
if [ $? -ne 0 ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–∞: $BACKUP_DIR"
    exit 1
fi

# --- –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø—ã ---
echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π:"
for file in "${UNIQUE_CONFLICTS[@]}"; do
    relative_path_for_backup=${file#"$HOME/"} # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –±—ç–∫–∞–ø–µ
    backup_target_path="$BACKUP_DIR/$relative_path_for_backup"
    backup_target_dir=$(dirname "$backup_target_path")

    # –°–æ–∑–¥–∞–µ–º –Ω—É–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ –±—ç–∫–∞–ø–∞
    mkdir -p "$backup_target_dir"

    echo "  - –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ '$file' –≤ '$backup_target_path'"
    cp -L -v "$file" "$backup_target_path" # -L —Ä–∞–∑—ã–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç —Å–∏–º–ª–∏–Ω–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –≤–¥—Ä—É–≥ –ø–æ–ø–∞–ª–∏—Å—å
done

echo "üì¶ –ë—ç–∫–∞–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $BACKUP_DIR/"

# --- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ó–∞–ø—É—Å–∫ stow ---
# read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å stow --adopt –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤? (y/N) " -n 1 -r
# echo
# if [[ $REPLY =~ ^[Yy]$ ]]; then
#     echo "–ó–∞–ø—É—Å–∫ 'stow --adopt */' –∏–∑ $DOTFILES_DIR..."
#     cd "$DOTFILES_DIR" && stow -v --adopt */
#     echo "‚úÖ Stow adopt –∑–∞–≤–µ—Ä—à–µ–Ω."
# else
#     echo "‚ÑπÔ∏è –ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ 'stow' –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ."
# fi

exit 0

